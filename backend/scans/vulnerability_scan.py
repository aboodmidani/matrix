import subprocess
from typing import Dict, List, Any

def run_nikto_scan(url: str) -> List[Dict[str, Any]]:
    """Run nikto command to scan for vulnerabilities"""
    try:
        result = subprocess.run(
            ['nikto', '-h', url, '-Format', 'txt', '-output', '/tmp/nikto_results.txt'],
            capture_output=True,
            text=True,
            timeout=180
        )
        
        if result.returncode == 0:
            output = result.stdout
            vulnerabilities = parse_nikto_output(output)
            return vulnerabilities
        else:
            return [{"error": result.stderr}]
            
    except subprocess.TimeoutExpired:
        return [{"error": "Vulnerability scan timed out"}]
    except Exception as e:
        return [{"error": str(e)}]

def parse_nikto_output(output: str) -> List[Dict[str, Any]]:
    """Parse nikto output to extract vulnerabilities"""
    vulnerabilities = []
    
    lines = output.split('\n')
    for line in lines:
        if '+ ' in line and ('VULN' in line.upper() or 'WARNING' in line.upper() or 'INFO' in line.upper()):
            # Parse nikto vulnerability lines
            severity = "Medium"  # Default severity
            if 'VULNERABILITY' in line.upper() or 'CRITICAL' in line.upper():
                severity = "High"
            elif 'INFO' in line.upper():
                severity = "Low"
            
            vuln_data = {
                "type": "Security Issue",
                "severity": severity,
                "description": line.strip('+ ').strip(),
                "url": ""
            }
            vulnerabilities.append(vuln_data)
    
    if not vulnerabilities:
        vulnerabilities.append({
            "type": "No vulnerabilities detected",
            "severity": "Info",
            "description": "No common vulnerabilities were detected in this scan"
        })
    
    return vulnerabilities