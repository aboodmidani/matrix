from typing import Dict, List, Any
from tools import tool_manager

def run_nikto_scan(url: str) -> List[Dict[str, Any]]:
    """Run nikto command to scan for vulnerabilities"""
    try:
        # Check if nikto is available
        if not tool_manager.check_tool_availability('nikto'):
            return [{
                "error": "Vulnerability scanning tool (nikto) not available in this environment. Please use a platform that supports system packages or configure nikto manually."
            }]
        
        success, stdout, stderr = tool_manager.run_command([
            'nikto', '-h', url, '-Format', 'txt', '-output', '/tmp/nikto_results.txt'
        ])
        
        if success:
            vulnerabilities = parse_nikto_output(stdout)
            return vulnerabilities
        else:
            return [{"error": f"Vulnerability scan failed: {stderr}"}]
            
    except Exception as e:
        return [{"error": f"Vulnerability scan error: {str(e)}"}]

def parse_nikto_output(output: str) -> List[Dict[str, Any]]:
    """Parse nikto output to extract vulnerabilities"""
    vulnerabilities = []
    
    lines = output.split('\n')
    for line in lines:
        if '+ ' in line and ('VULN' in line.upper() or 'WARNING' in line.upper() or 'INFO' in line.upper()):
            # Parse nikto vulnerability lines
            severity = "Medium"  # Default severity
            if 'VULNERABILITY' in line.upper() or 'CRITICAL' in line.upper():
                severity = "High"
            elif 'INFO' in line.upper():
                severity = "Low"
            
            vuln_data = {
                "type": "Security Issue",
                "severity": severity,
                "description": line.strip('+ ').strip(),
                "url": ""
            }
            vulnerabilities.append(vuln_data)
    
    if not vulnerabilities:
        vulnerabilities.append({
            "type": "No vulnerabilities detected",
            "severity": "Info",
            "description": "No common vulnerabilities were detected in this scan"
        })
    
    return vulnerabilities
